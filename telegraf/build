# docker-compose.yml fragment
#  telegraf:
#    image: telegraf:1.12.6-alpine-custom
#    build:
#      context: "telegraf"
#      args:
#        - TELEGRAF_VERSION=1.12.6
#    container_name: telegraf
#    hostname: tgf-appserver01
#    environment:
#      - INFLUX_DB_HOST=http://influxdb:8086
#      - HOST_PROC=/rootfs/proc
#      - HOST_SYS=/rootfs/sys
#      - HOST_ETC=/rootfs/etc
#    volumes:
#      - ${PWD}/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#      - /sys:/rootfs/sys:ro
#      - /proc:/rootfs/proc:ro
#      - /etc:/rootfs/etc:ro

TELEGRAF_VERSION=1.12.6

ARCH=$(uname -m)

IMAGE_TAG=${TELEGRAF_VERSION}-alpine-${ARCH}
IMAGE=telegraf:${IMAGE_TAG}

INFLUX_DB_HOST=http://influxdb:8086
HOST_PROC=/rootfs/proc
HOST_SYS=/rootfs/sys
HOST_ETC=/rootfs/etc


docker build -t $IMAGE --build-arg TELEGRAF_VERSION=1.12.6 .  && \
docker run --rm --name telegraf \
        -e INFLUX_DB_HOST=$INFLUX_DB_HOST \
        -e HOST_PROC=$HOST_PROC \
        -e HOST_SYS=$HOST_SYS \
        -e HOST_ETC=$HOST_ETC \
        -v ./telegraf.conf:/etc/telegraf/telegraf.conf:ro \
        -v /var/run/docker.sock:/var/run/docker.sock:ro \
        -v /proc:$HOST_PROC:ro \
        -v /sys:$HOST_SYS:ro   \
        -v /etc:$HOST_ETC:ro   \
        $IMAGE

